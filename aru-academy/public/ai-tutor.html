<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor - ARU Academy</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="dashboard.html">
                        <h1>ARU Academy</h1>
                    </a>
                </div>
                <nav class="nav">
                    <ul class="nav-list">
                        <li><a href="dashboard.html">Dashboard</a></li>
                        <li><a href="courses.html">Courses</a></li>
                        <li><a href="quizzes.html">Quizzes</a></li>
                        <li><a href="ai-tutor.html" class="active">AI Tutor</a></li>
                        <li id="adminLink" style="display: none;"><a href="admin.html">Admin</a></li>
                    </ul>
                </nav>
                <div class="user-menu">
                    <div class="user-info">
                        <span id="userName">Loading...</span>
                        <span class="user-role" id="userRole">Loading...</span>
                    </div>
                    <div class="dropdown">
                        <button class="dropdown-toggle" id="userMenuToggle">
                            <span class="avatar">üë§</span>
                        </button>
                        <div class="dropdown-menu" id="userMenu">
                            <a href="profile.html">Profile</a>
                            <a href="#" id="logoutBtn">Logout</a>
                        </div>
                    </div>
                </div>
                <div class="nav-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <section class="ai-tutor-section">
            <div class="container">
                <div class="ai-tutor-header">
                    <h1>ü§ñ AI Tutor</h1>
                    <p>Get instant help with your studies using our AI-powered tutor</p>
                </div>

                <!-- AI Tutor Navigation -->
                <div class="ai-tutor-nav">
                    <button class="nav-btn active" data-tab="ask">üí¨ Ask Question</button>
                    <button class="nav-btn" data-tab="generate">üìù Generate Quiz</button>
                    <button class="nav-btn" data-tab="history">üìö Question History</button>
                </div>

                <!-- Ask Question Tab -->
                <div class="tab-content active" id="askTab">
                    <div class="ai-chat-container">
                        <div class="chat-header">
                            <h3>üí¨ Chat with AI Tutor</h3>
                            <p>Ask me anything about your studies - I'm here to help!</p>
                        </div>
                        
                        <div class="chat-messages" id="chatMessages">
                            <div class="message ai-message">
                                <div class="message-avatar">ü§ñ</div>
                                <div class="message-content">
                                    <p>Hello! I'm your AI tutor. I can help you understand complex topics, explain concepts, and provide detailed answers to your questions. What would you like to learn about today?</p>
                                    <div class="message-time">Just now</div>
                                </div>
                            </div>
                        </div>

                        <div class="chat-input-container">
                            <form id="questionForm" class="chat-form">
                                <div class="input-group">
                                    <input type="text" id="questionInput" placeholder="Type your question here..." required>
                                    <button type="submit" class="btn btn-primary" id="askBtn">
                                        <span class="btn-text">Ask</span>
                                        <span class="btn-loading" style="display: none;">üîÑ</span>
                                    </button>
                                </div>
                                <div class="input-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="includeContext" checked>
                                        <span class="checkmark"></span>
                                        Include course context for better answers
                                    </label>
                                </div>
                                
                                <div class="quick-questions">
                                    <div class="quick-question" onclick="askQuickQuestion('Explain this concept in simple terms')">
                                        üí° Explain in simple terms
                                    </div>
                                    <div class="quick-question" onclick="askQuickQuestion('Give me examples of this topic')">
                                        üìù Give me examples
                                    </div>
                                    <div class="quick-question" onclick="askQuickQuestion('What are the key points to remember?')">
                                        üéØ Key points
                                    </div>
                                    <div class="quick-question" onclick="askQuickQuestion('How does this relate to other topics?')">
                                        üîó How does this relate?
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Generate Quiz Tab -->
                <div class="tab-content" id="generateTab">
                    <div class="quiz-generator-container">
                        <div class="generator-header">
                            <h3>Generate Quiz Questions</h3>
                            <p>Create custom quizzes from any topic or resource</p>
                        </div>

                        <form id="quizGeneratorForm" class="generator-form">
                            <div class="form-group">
                                <label for="courseContext">Course Context</label>
                                <select id="courseContext" name="course_id" required>
                                    <option value="">Select Course</option>
                                </select>
                                <small>Select a course to access its topics and generate relevant questions</small>
                            </div>

                            <div class="form-group">
                                <label for="quizTopic">Topic</label>
                                <select id="quizTopic" name="topic" required disabled>
                                    <option value="">Select a course first</option>
                                </select>
                                <small>Topics are automatically loaded from the selected course</small>
                            </div>

                            <div class="form-group">
                                <label for="quizType">Quiz Type</label>
                                <select id="quizType" name="type" required>
                                    <option value="">Select Quiz Type</option>
                                    <option value="mixed">Mixed (MCQ + Short Answer)</option>
                                    <option value="mcq">Multiple Choice Only</option>
                                    <option value="short">Short Answer Only</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="questionCount">Number of Questions</label>
                                <select id="questionCount" name="count" required>
                                    <option value="5">5 Questions</option>
                                    <option value="10" selected>10 Questions</option>
                                    <option value="15">15 Questions</option>
                                    <option value="20">20 Questions</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="difficultyLevel">Difficulty Level</label>
                                <select id="difficultyLevel" name="difficulty" required>
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate" selected>Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="additionalContext">Additional Context</label>
                                <textarea id="additionalContext" name="context" rows="4" placeholder="Provide any additional context, specific concepts, or learning objectives..."></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary btn-full" id="generateQuizBtn">
                                <span class="btn-text">Generate Quiz</span>
                                <span class="btn-loading" style="display: none;">üîÑ</span>
                            </button>
                        </form>

                        <div class="generated-quiz" id="generatedQuiz" style="display: none;">
                            <div class="quiz-header">
                                <h4>Generated Quiz</h4>
                                <button class="btn btn-outline btn-sm" id="saveQuizBtn">Save Quiz</button>
                            </div>
                            <div class="quiz-content" id="quizContent">
                                <!-- Generated quiz content will appear here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Question History Tab -->
                <div class="tab-content" id="historyTab">
                    <div class="history-container">
                        <div class="history-header">
                            <h3>Your Question History</h3>
                            <div class="history-filters">
                                <select id="historyFilter">
                                    <option value="all">All Questions</option>
                                    <option value="recent">Recent</option>
                                    <option value="favorites">Favorites</option>
                                </select>
                                <button class="btn btn-outline btn-sm" id="clearHistoryBtn">Clear History</button>
                            </div>
                        </div>

                        <div class="history-list" id="historyList">
                            <div class="loading-spinner">Loading history...</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Save Quiz Modal -->
    <div class="modal" id="saveQuizModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Save Quiz</h3>
                <button class="modal-close" id="closeSaveModal">&times;</button>
            </div>
            <form id="saveQuizForm">
                <div class="form-group">
                    <label for="quizTitle">Quiz Title</label>
                    <input type="text" id="quizTitle" name="title" required>
                </div>
                <div class="form-group">
                    <label for="quizDescription">Description</label>
                    <textarea id="quizDescription" name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="quizCourse">Assign to Course (Optional)</label>
                    <select id="quizCourse" name="course_id">
                        <option value="">No Course Assignment</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" id="cancelSave">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Quiz</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>ARU Academy</h3>
                    <p>Empowering education through technology and innovation.</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="dashboard.html">Dashboard</a></li>
                        <li><a href="courses.html">Courses</a></li>
                        <li><a href="quizzes.html">Quizzes</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact</h4>
                    <p>Email: info@aru.academy</p>
                    <p>Phone: +1 (555) 123-4567</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 ARU Academy. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/ui.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script>
        // AI Tutor functionality
        function askQuickQuestion(question) {
            document.getElementById('questionInput').value = question;
            document.getElementById('questionForm').dispatchEvent(new Event('submit'));
        }
        
        function addMessage(content, isUser = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${isUser ? 'üë§' : 'ü§ñ'}</div>
                <div class="message-content">
                    <p>${content}</p>
                    <div class="message-time">${timeString}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai-message';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        AI is typing
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        async function askAIQuestion(question) {
            try {
                showTypingIndicator();
                
                const response = await api.post('/api/ai/ask', {
                    question: question,
                    include_context: document.getElementById('includeContext').checked
                });
                
                hideTypingIndicator();
                
                if (response.success) {
                    addMessage(response.data.answer);
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.');
                }
            } catch (error) {
                hideTypingIndicator();
                console.error('Error asking AI question:', error);
                addMessage('Sorry, I encountered an error. Please try again.');
            }
        }
    </script>
    <script>
        // Check authentication
        if (!localStorage.getItem('user')) {
            window.location.href = 'login.html';
        }
        
        // Handle form submission
        document.getElementById('questionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value.trim();
            
            if (!question) return;
            
            // Add user message
            addMessage(question, true);
            
            // Clear input
            questionInput.value = '';
            
            // Ask AI
            await askAIQuestion(question);
        });

        const user = JSON.parse(localStorage.getItem('user'));
        const userRole = user.role;

        // Update UI based on user role
        document.getElementById('userName').textContent = user.name;
        document.getElementById('userRole').textContent = userRole;

        // Show admin link if applicable
        if (userRole === 'Admin') {
            document.getElementById('adminLink').style.display = 'block';
        }

        // AI Tutor functionality
        let chatHistory = [];
        let currentQuiz = null;

        // Tab functionality
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active class from all tabs and contents
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Show corresponding content
                const tabName = this.dataset.tab;
                document.getElementById(tabName + 'Tab').classList.add('active');
                
                // Load tab-specific data
                if (tabName === 'history') {
                    loadQuestionHistory();
                } else if (tabName === 'generate') {
                    loadUserCourses();
                }
            });
        });

        // Question form submission
        document.getElementById('questionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value.trim();
            
            if (!question) return;

            const includeContext = document.getElementById('includeContext').checked;
            
            // Add user question to chat
            addMessage('user', question);
            questionInput.value = '';

            // Show loading state
            const askBtn = document.getElementById('askBtn');
            const btnText = askBtn.querySelector('.btn-text');
            const btnLoading = askBtn.querySelector('.btn-loading');
            
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            askBtn.disabled = true;

            try {
                // Prepare request data
                const requestData = {
                    question: question,
                    include_context: includeContext
                };

                // If including context, get user's current courses
                if (includeContext) {
                    try {
                        const coursesResponse = await api.get('/api/courses/');
                        if (coursesResponse.success && coursesResponse.data.length > 0) {
                            requestData.course_context = coursesResponse.data.map(c => ({
                                id: c.id,
                                title: c.title,
                                description: c.description
                            }));
                        }
                    } catch (error) {
                        console.error('Error loading course context:', error);
                    }
                }

                // Send question to AI
                const response = await api.post('/api/ai/ask', requestData);

                if (response.success) {
                    const answer = response.data.answer;
                    addMessage('ai', answer);
                    
                    // Save to history
                    saveQuestionToHistory(question, answer);
                } else {
                    addMessage('ai', 'Sorry, I encountered an error while processing your question. Please try again.');
                }
            } catch (error) {
                console.error('Error asking question:', error);
                addMessage('ai', 'Sorry, I encountered an error while processing your question. Please try again.');
            } finally {
                // Reset button state
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                askBtn.disabled = false;
            }
        });

        // Quiz generator form submission
        document.getElementById('quizGeneratorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const quizData = {
                topic: formData.get('topic'),
                type: formData.get('type'),
                num_questions: parseInt(formData.get('count')),
                difficulty: formData.get('difficulty'),
                course_id: formData.get('course_id') || null,
                context: formData.get('context')
            };

            // Show loading state
            const generateBtn = document.getElementById('generateQuizBtn');
            const btnText = generateBtn.querySelector('.btn-text');
            const btnLoading = generateBtn.querySelector('.btn-loading');
            
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            generateBtn.disabled = true;

            try {
                const response = await api.post('/api/ai/generate-questions', quizData);

                if (response.success) {
                    currentQuiz = response.data;
                    displayGeneratedQuiz(currentQuiz);
                    document.getElementById('generatedQuiz').style.display = 'block';
                } else {
                    showAlert(response.message || 'Failed to generate quiz', 'error');
                }
            } catch (error) {
                console.error('Error generating quiz:', error);
                showAlert('An error occurred while generating the quiz', 'error');
            } finally {
                // Reset button state
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                generateBtn.disabled = false;
            }
        });

        // Save quiz functionality
        document.getElementById('saveQuizBtn').addEventListener('click', function() {
            if (currentQuiz) {
                document.getElementById('quizTitle').value = currentQuiz.topic || 'Generated Quiz';
                document.getElementById('saveQuizModal').style.display = 'block';
                document.body.classList.add('modal-open');
            }
        });

        // Course selection event listener
        document.getElementById('courseContext').addEventListener('change', function() {
            const courseId = this.value;
            const topicSelect = document.getElementById('quizTopic');
            
            if (courseId) {
                // Enable topic select and load topics
                topicSelect.disabled = false;
                topicSelect.innerHTML = '<option value="">Loading topics...</option>';
                loadCourseTopics(courseId);
            } else {
                // Disable topic select and reset
                topicSelect.disabled = true;
                topicSelect.innerHTML = '<option value="">Select a course first</option>';
            }
        });

        // Save quiz form submission
        document.getElementById('saveQuizForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const quizData = {
                title: formData.get('title'),
                description: formData.get('description'),
                course_id: formData.get('course_id') || null,
                questions: currentQuiz.questions
            };

            try {
                showLoading();
                
                const response = await api.post('/api/quizzes/', quizData);

                if (response.success) {
                    showAlert('Quiz saved successfully!', 'success');
                    document.getElementById('saveQuizModal').style.display = 'none';
                    document.body.classList.remove('modal-open');
                    document.getElementById('generatedQuiz').style.display = 'none';
                    currentQuiz = null;
                } else {
                    showAlert(response.message || 'Failed to save quiz', 'error');
                }
            } catch (error) {
                console.error('Error saving quiz:', error);
                showAlert('An error occurred while saving the quiz', 'error');
            } finally {
                hideLoading();
            }
        });

        // Modal close functionality
        document.getElementById('closeSaveModal').addEventListener('click', function() {
            document.getElementById('saveQuizModal').style.display = 'none';
            document.body.classList.remove('modal-open');
        });

        document.getElementById('cancelSave').addEventListener('click', function() {
            document.getElementById('saveQuizModal').style.display = 'none';
            document.body.classList.remove('modal-open');
        });

        // Clear history functionality
        document.getElementById('clearHistoryBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear your question history? This action cannot be undone.')) {
                clearQuestionHistory();
            }
        });

        // History filter functionality
        document.getElementById('historyFilter').addEventListener('change', function() {
            loadQuestionHistory(this.value);
        });

        // Helper functions
        function addMessage(sender, content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const avatar = sender === 'user' ? 'üë§' : 'ü§ñ';
            const messageContent = sender === 'user' ? content : formatAIResponse(content);
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    ${messageContent}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Add to chat history
            chatHistory.push({ sender, content, timestamp: new Date() });
        }

        function formatAIResponse(content) {
            // Convert markdown-like formatting to HTML
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>')
                .replace(/```(.*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`(.*?)`/g, '<code>$1</code>');
        }

        function displayGeneratedQuiz(quiz) {
            const quizContent = document.getElementById('quizContent');
            
            let questionsHTML = `
                <div class="quiz-instructions">
                    <h4>üìù Quiz Instructions</h4>
                    <p>‚Ä¢ Read each question carefully</p>
                    <p>‚Ä¢ Select the best answer for each question</p>
                    <p>‚Ä¢ Click "Submit Quiz" when you're done</p>
                    <p>‚Ä¢ You'll see your score and explanations after submission</p>
                </div>
                <div class="quiz-timer" id="quizTimer" style="display: none;">
                    <span>‚è±Ô∏è Time: <span id="timeDisplay">00:00</span></span>
                </div>
            `;
            
            quiz.questions.forEach((question, index) => {
                if (question.type === 'multiple_choice') {
                    questionsHTML += `
                        <div class="quiz-question" data-question-id="${index}">
                            <h5>Question ${index + 1}</h5>
                            <p>${question.question}</p>
                            <div class="question-options">
                                ${question.options.map((option, optIndex) => 
                                    `<label class="option-label">
                                        <input type="radio" name="q${index}" value="${optIndex}" data-correct="${optIndex === question.correct_answer}">
                                        <span class="option-text">${String.fromCharCode(65 + optIndex)}. ${option}</span>
                                    </label>`
                                ).join('')}
                            </div>
                            <div class="question-feedback" id="feedback-${index}" style="display: none;">
                                <div class="feedback-content">
                                    <div class="feedback-result"></div>
                                    <div class="feedback-explanation"></div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (question.type === 'short_answer') {
                    questionsHTML += `
                        <div class="quiz-question" data-question-id="${index}">
                            <h5>Question ${index + 1}</h5>
                            <p>${question.question}</p>
                            <div class="short-answer-container">
                                <textarea 
                                    name="q${index}" 
                                    id="answer-${index}" 
                                    class="short-answer-input" 
                                    placeholder="Type your answer here..."
                                    rows="4"
                                ></textarea>
                                <div class="answer-hint">üí° Tip: Be specific and provide examples when possible</div>
                            </div>
                            <div class="question-feedback" id="feedback-${index}" style="display: none;">
                                <div class="feedback-content">
                                    <div class="feedback-result"></div>
                                    <div class="feedback-explanation"></div>
                                    <div class="feedback-suggestions"></div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    questionsHTML += `
                        <div class="quiz-question" data-question-id="${index}">
                            <h5>Question ${index + 1}</h5>
                            <p>${question.question}</p>
                            <div class="question-answer">
                                <strong>Answer:</strong> ${question.answer}
                            </div>
                            ${question.explanation ? `<div class="question-explanation"><strong>Explanation:</strong> ${question.explanation}</div>` : ''}
                        </div>
                    `;
                }
            });
            
            questionsHTML += `
                <div class="quiz-actions">
                    <button class="btn btn-primary" id="submitQuizBtn">Submit Quiz</button>
                    <button class="btn btn-outline" id="resetQuizBtn">Reset Answers</button>
                </div>
                <div class="quiz-results" id="quizResults" style="display: none;">
                    <div class="results-header">
                        <h4>üìä Quiz Results</h4>
                    </div>
                    <div class="results-content">
                        <div class="score-display">
                            <div class="score-circle">
                                <span class="score-number" id="scoreNumber">0</span>
                                <span class="score-total">/ ${quiz.questions.length}</span>
                            </div>
                            <div class="score-percentage" id="scorePercentage">0%</div>
                        </div>
                        <div class="score-breakdown">
                            <div class="correct-answers">
                                <span class="correct-count" id="correctCount">0</span> Correct
                            </div>
                            <div class="incorrect-answers">
                                <span class="incorrect-count" id="incorrectCount">0</span> Incorrect
                            </div>
                        </div>
                        <div class="performance-message" id="performanceMessage"></div>
                    </div>
                </div>
            `;
            
            quizContent.innerHTML = questionsHTML;
            
            // Add event listeners for the new interactive elements
            setupQuizInteractivity(quiz);
        }
        
        function setupQuizInteractivity(quiz) {
            // Submit quiz functionality
            document.getElementById('submitQuizBtn').addEventListener('click', function() {
                submitQuiz(quiz);
            });
            
            // Reset quiz functionality
            document.getElementById('resetQuizBtn').addEventListener('click', function() {
                resetQuiz();
            });
            
            // Add change listeners to radio buttons for immediate feedback (optional)
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    // Optional: Show immediate feedback or just track selection
                    const questionId = this.name.replace('q', '');
                    const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
                    questionElement.classList.add('answered');
                });
            });
        }
        
        async function submitQuiz(quiz) {
            const answers = {};
            let correctCount = 0;
            let totalQuestions = quiz.questions.length;
            let processedQuestions = 0;
            
            // Show loading state
            const submitBtn = document.getElementById('submitQuizBtn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Evaluating Answers...';
            submitBtn.disabled = true;
            
            // Collect answers and check correctness
            for (let index = 0; index < quiz.questions.length; index++) {
                const question = quiz.questions[index];
                const questionElement = document.querySelector(`[data-question-id="${index}"]`);
                const feedbackElement = document.getElementById(`feedback-${index}`);
                
                if (question.type === 'multiple_choice') {
                    const selectedAnswer = document.querySelector(`input[name="q${index}"]:checked`);
                    
                    if (selectedAnswer) {
                        const selectedIndex = parseInt(selectedAnswer.value);
                        const isCorrect = selectedIndex === question.correct_answer;
                        
                        answers[index] = {
                            selected: selectedIndex,
                            correct: question.correct_answer,
                            isCorrect: isCorrect
                        };
                        
                        if (isCorrect) {
                            correctCount++;
                        }
                        
                        // Show feedback
                        showQuestionFeedback(feedbackElement, question, selectedIndex, isCorrect);
                    } else {
                        answers[index] = {
                            selected: null,
                            correct: question.correct_answer,
                            isCorrect: false
                        };
                        
                        // Show feedback for unanswered question
                        showQuestionFeedback(feedbackElement, question, null, false);
                    }
                } else if (question.type === 'short_answer') {
                    const studentAnswer = document.getElementById(`answer-${index}`).value.trim();
                    
                    if (studentAnswer) {
                        try {
                            // Evaluate short answer using AI
                            const evaluation = await evaluateShortAnswer(question.question, studentAnswer, question.correct_answer);
                            
                            answers[index] = {
                                studentAnswer: studentAnswer,
                                correctAnswer: question.correct_answer,
                                isCorrect: evaluation.is_correct,
                                score: evaluation.score,
                                feedback: evaluation.feedback,
                                suggestions: evaluation.suggestions
                            };
                            
                            if (evaluation.is_correct) {
                                correctCount++;
                            }
                            
                            // Show feedback
                            showShortAnswerFeedback(feedbackElement, question, studentAnswer, evaluation);
                        } catch (error) {
                            console.error('Error evaluating short answer:', error);
                            // Fallback to treating as incorrect
                            answers[index] = {
                                studentAnswer: studentAnswer,
                                correctAnswer: question.correct_answer,
                                isCorrect: false,
                                score: 0,
                                feedback: "Unable to evaluate answer at this time.",
                                suggestions: "Please try again later."
                            };
                            
                            showShortAnswerFeedback(feedbackElement, question, studentAnswer, answers[index]);
                        }
                    } else {
                        answers[index] = {
                            studentAnswer: '',
                            correctAnswer: question.correct_answer,
                            isCorrect: false,
                            score: 0,
                            feedback: "No answer provided.",
                            suggestions: "Please provide an answer to receive feedback."
                        };
                        
                        showShortAnswerFeedback(feedbackElement, question, '', answers[index]);
                    }
                }
                
                processedQuestions++;
                // Update progress
                submitBtn.textContent = `Evaluating... ${processedQuestions}/${totalQuestions}`;
            }
            
            // Calculate score
            const score = correctCount;
            const percentage = Math.round((correctCount / totalQuestions) * 100);
            
            // Display results
            displayQuizResults(score, totalQuestions, percentage);
            
            // Reset button
            submitBtn.textContent = originalText;
            submitBtn.disabled = true;
            document.getElementById('resetQuizBtn').disabled = true;
            
            // Disable all inputs
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => radio.disabled = true);
            
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(textarea => textarea.disabled = true);
        }
        
        async function evaluateShortAnswer(question, studentAnswer, correctAnswer) {
            try {
                const response = await api.post('/api/ai/evaluate-answer', {
                    question: question,
                    student_answer: studentAnswer,
                    correct_answer: correctAnswer
                });
                
                if (response.success) {
                    return response.evaluation;
                } else {
                    throw new Error(response.message || 'Evaluation failed');
                }
            } catch (error) {
                console.error('Error calling evaluation API:', error);
                throw error;
            }
        }
        
        function showQuestionFeedback(feedbackElement, question, selectedIndex, isCorrect) {
            const feedbackContent = feedbackElement.querySelector('.feedback-content');
            const resultDiv = feedbackContent.querySelector('.feedback-result');
            const explanationDiv = feedbackContent.querySelector('.feedback-explanation');
            
            if (isCorrect) {
                resultDiv.innerHTML = `
                    <div class="feedback-correct">
                        <span class="feedback-icon">‚úÖ</span>
                        <span class="feedback-text">Correct!</span>
                    </div>
                `;
            } else {
                const correctOption = String.fromCharCode(65 + question.correct_answer);
                resultDiv.innerHTML = `
                    <div class="feedback-incorrect">
                        <span class="feedback-icon">‚ùå</span>
                        <span class="feedback-text">Incorrect. The correct answer is ${correctOption}.</span>
                    </div>
                `;
            }
            
            explanationDiv.innerHTML = `
                <div class="explanation-text">
                    <strong>Explanation:</strong> ${question.explanation}
                </div>
            `;
            
            feedbackElement.style.display = 'block';
        }
        
        function showShortAnswerFeedback(feedbackElement, question, studentAnswer, evaluation) {
            const feedbackContent = feedbackElement.querySelector('.feedback-content');
            const resultDiv = feedbackContent.querySelector('.feedback-result');
            const explanationDiv = feedbackContent.querySelector('.feedback-explanation');
            const suggestionsDiv = feedbackContent.querySelector('.feedback-suggestions');
            
            if (evaluation.is_correct) {
                resultDiv.innerHTML = `
                    <div class="feedback-correct">
                        <span class="feedback-icon">‚úÖ</span>
                        <span class="feedback-text">Good Answer! (${evaluation.score}%)</span>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="feedback-incorrect">
                        <span class="feedback-icon">‚ùå</span>
                        <span class="feedback-text">Needs Improvement (${evaluation.score}%)</span>
                    </div>
                `;
            }
            
            explanationDiv.innerHTML = `
                <div class="explanation-text">
                    <strong>Feedback:</strong> ${evaluation.feedback}
                </div>
            `;
            
            if (evaluation.suggestions) {
                suggestionsDiv.innerHTML = `
                    <div class="suggestions-text">
                        <strong>Suggestions:</strong> ${evaluation.suggestions}
                    </div>
                `;
            }
            
            feedbackElement.style.display = 'block';
        }
        
        function displayQuizResults(score, total, percentage) {
            document.getElementById('scoreNumber').textContent = score;
            document.getElementById('scorePercentage').textContent = percentage + '%';
            document.getElementById('correctCount').textContent = score;
            document.getElementById('incorrectCount').textContent = total - score;
            
            // Performance message
            let performanceMessage = '';
            if (percentage >= 90) {
                performanceMessage = 'üéâ Excellent work! You have a strong understanding of this topic.';
            } else if (percentage >= 80) {
                performanceMessage = 'üëç Good job! You have a solid grasp of the material.';
            } else if (percentage >= 70) {
                performanceMessage = 'üìö Not bad! Review the explanations and try again.';
            } else if (percentage >= 60) {
                performanceMessage = 'üí™ Keep studying! Focus on the areas you missed.';
            } else {
                performanceMessage = 'üìñ More study needed. Review the material and explanations carefully.';
            }
            
            document.getElementById('performanceMessage').textContent = performanceMessage;
            document.getElementById('quizResults').style.display = 'block';
            
            // Scroll to results
            document.getElementById('quizResults').scrollIntoView({ behavior: 'smooth' });
        }
        
        function resetQuiz() {
            // Clear all selections
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.checked = false;
                radio.disabled = false;
            });
            
            // Clear all textareas
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                textarea.value = '';
                textarea.disabled = false;
            });
            
            // Hide all feedback
            const feedbackElements = document.querySelectorAll('.question-feedback');
            feedbackElements.forEach(feedback => {
                feedback.style.display = 'none';
            });
            
            // Hide results
            document.getElementById('quizResults').style.display = 'none';
            
            // Re-enable buttons
            document.getElementById('submitQuizBtn').disabled = false;
            document.getElementById('resetQuizBtn').disabled = false;
            
            // Remove answered class from questions
            const questionElements = document.querySelectorAll('.quiz-question');
            questionElements.forEach(question => {
                question.classList.remove('answered');
            });
        }

        async function loadUserCourses() {
            try {
                console.log('üîÑ Loading user courses...');
                const response = await api.get('/api/courses/ai-tutor');
                console.log('üìä Courses API response:', response);
                if (response.success) {
                    console.log('‚úÖ Courses loaded successfully:', response.data);
                    populateCourseSelects(response.data);
                } else {
                    console.error('‚ùå Courses API returned error:', response.message);
                    showAlert('Failed to load courses: ' + (response.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('‚ùå Error loading user courses:', error);
                showAlert('Failed to load courses: ' + error.message, 'error');
            }
        }

        function populateCourseSelects(courses) {
            console.log('üîÑ Populating course selects with:', courses);
            const courseContext = document.getElementById('courseContext');
            const quizCourse = document.getElementById('quizCourse');
            
            if (courseContext) {
                courseContext.innerHTML = '<option value="">Select Course</option>';
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = `${course.code} - ${course.title} (${course.department})`;
                    courseContext.appendChild(option);
                    console.log('‚úÖ Added course option:', option.textContent);
                });
                console.log('‚úÖ Course context populated with', courses.length, 'courses');
            } else {
                console.error('‚ùå Course context element not found');
            }
            
            if (quizCourse) {
                quizCourse.innerHTML = '<option value="">No Course Assignment</option>';
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = `${course.code} - ${course.title}`;
                    quizCourse.appendChild(option);
                });
                console.log('‚úÖ Quiz course populated with', courses.length, 'courses');
            } else {
                console.error('‚ùå Quiz course element not found');
            }
        }

        async function loadCourseTopics(courseId) {
            try {
                const response = await api.get(`/api/courses/${courseId}/topics`);
                if (response.success) {
                    populateTopicSelect(response.data);
                } else {
                    console.error('Failed to load topics:', response.message);
                    showAlert('Failed to load course topics', 'error');
                }
            } catch (error) {
                console.error('Error loading course topics:', error);
                showAlert('Failed to load course topics', 'error');
            }
        }

        function populateTopicSelect(topics) {
            const topicSelect = document.getElementById('quizTopic');
            
            if (topicSelect) {
                topicSelect.innerHTML = '<option value="">Select Topic</option>';
                
                if (topics.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No topics available for this course';
                    option.disabled = true;
                    topicSelect.appendChild(option);
                } else {
                    topics.forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic.title;
                        option.textContent = topic.title;
                        if (topic.description) {
                            option.title = topic.description;
                        }
                        topicSelect.appendChild(option);
                    });
                }
            }
        }

        async function loadQuestionHistory(filter = 'all') {
            try {
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '<div class="loading-spinner">Loading history...</div>';
                
                const response = await api.get('/api/ai/logs', { filter });
                
                if (response.success && response.data.length > 0) {
                    const historyHTML = response.data.map(log => `
                        <div class="history-item">
                            <div class="history-question">
                                <strong>Q:</strong> ${log.request_data.question || 'Question not available'}
                            </div>
                            <div class="history-answer">
                                <strong>A:</strong> ${log.response_data.answer || 'Answer not available'}
                            </div>
                            <div class="history-meta">
                                <span class="history-date">${new Date(log.created_at).toLocaleDateString()}</span>
                                <span class="history-time">${new Date(log.created_at).toLocaleTimeString()}</span>
                            </div>
                        </div>
                    `).join('');
                    
                    historyList.innerHTML = historyHTML;
                } else {
                    historyList.innerHTML = '<p class="text-muted">No question history found</p>';
                }
            } catch (error) {
                console.error('Error loading question history:', error);
                document.getElementById('historyList').innerHTML = '<p class="text-muted">Error loading history</p>';
            }
        }

        function saveQuestionToHistory(question, answer) {
            // This would typically be handled by the backend when logging AI calls
            // For now, we'll just store it locally
            const historyItem = {
                question,
                answer,
                timestamp: new Date()
            };
            
            let history = JSON.parse(localStorage.getItem('aiQuestionHistory') || '[]');
            history.unshift(historyItem);
            
            // Keep only last 50 questions
            if (history.length > 50) {
                history = history.slice(0, 50);
            }
            
            localStorage.setItem('aiQuestionHistory', JSON.stringify(history));
        }

        function clearQuestionHistory() {
            localStorage.removeItem('aiQuestionHistory');
            loadQuestionHistory();
            showAlert('Question history cleared successfully', 'success');
        }

        // Load initial data
        loadUserCourses();

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            try {
                // Use the auth service for proper logout
                const authService = new AuthService();
                await authService.logout();
                localStorage.removeItem('user');
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
                localStorage.removeItem('user');
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            }
        });

        // User menu toggle
        document.getElementById('userMenuToggle').addEventListener('click', function() {
            document.getElementById('userMenu').classList.toggle('show');
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                document.getElementById('userMenu').classList.remove('show');
            }
        });
    </script>
</body>
</html>

